{"version":3,"file":"api.js","sourceRoot":"","sources":["../../tasks/api.ts"],"names":[],"mappings":"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","sourcesContent":["import IMultiTask = grunt.task.IMultiTask;\nimport typedoc, { Options as TypedocOptions } from '../src/commands/typedoc';\nimport wrapAsyncTask from './util/wrapAsyncTask';\nimport GitHub, { Release } from '../src/util/GitHub';\nimport sync from '../src/commands/sync';\nimport getReleases, {\n\tcreateHtmlApiMissingFilter,\n\tcreateJsonApiMissingFilter,\n\tcreateVersionFilter,\n\tgetHtmlApiPath,\n\tgetJsonApiPath,\n\tlatestFilter,\n\tReleaseFilter\n} from '../src/commands/getReleases';\nimport { join, resolve } from 'path';\nimport { mkdtempSync } from 'fs';\nimport installDependencies from '../src/commands/installDependencies';\nimport { logger } from '../src/log';\n\ninterface BaseOptions {\n\tdest: string;\n\tformat: 'html' | 'json';\n\tskipInstall: boolean;\n\tsrc: string;\n\ttypedoc?: Partial<TypedocOptions>;\n}\n\ninterface RemoteApiOptions extends BaseOptions {\n\tcloneDirectory?: string;\n\tfilter?: ReleaseFilter | ReleaseFilter[] | string;\n\trepo: {\n\t\towner: string;\n\t\tname: string;\n\t} | string;\n}\n\ntype TaskOptions = BaseOptions | RemoteApiOptions;\n\nfunction isRemoteOptions(options: any): options is RemoteApiOptions {\n\treturn !!options.repo;\n}\n\nfunction getGitHub(repo: RemoteApiOptions['repo']) {\n\tif (typeof repo === 'string') {\n\t\tconst [ owner, name ] =  repo.split('/');\n\t\treturn new GitHub(owner, name);\n\t}\n\telse {\n\t\treturn new GitHub(repo.owner, repo.name);\n\t}\n}\n\nasync function getMissing(repo: GitHub, options: RemoteApiOptions): Promise<Release[]> {\n\tconst filters = getFilterOptions(options.filter);\n\n\tif (options.format === 'json') {\n\t\tfilters.push(createJsonApiMissingFilter(repo.name, options.dest));\n\t}\n\telse {\n\t\tfilters.push(createHtmlApiMissingFilter(repo.name, options.dest));\n\t}\n\n\treturn getReleases(repo, filters);\n}\n\nfunction getFilterOptions(filter?: RemoteApiOptions['filter']): ReleaseFilter[] {\n\tif (!filter) {\n\t\treturn [];\n\t}\n\tif (filter === 'latest') {\n\t\treturn [ latestFilter ];\n\t}\n\tif (typeof filter === 'string') {\n\t\treturn [ createVersionFilter(filter) ];\n\t}\n\tif (Array.isArray(filter)) {\n\t\treturn filter;\n\t}\n\n\treturn [ filter ];\n}\n\nfunction createTempDirectory(name: string = ''): string {\n\treturn mkdtempSync(join('.sync', name));\n}\n\nexport = function (grunt: IGrunt) {\n\tasync function typedocTask(this: IMultiTask<any>) {\n\t\tconst options: any = this.options<Partial<TaskOptions>>({\n\t\t\tformat: 'html',\n\t\t\ttypedoc: {\n\t\t\t\tmode: 'file',\n\t\t\t\texternalPattern: '**/+(example|examples|node_modules|tests|typings)/**/*.ts',\n\t\t\t\texcludeExternals: true,\n\t\t\t\texcludeNotExported: true,\n\t\t\t\tignoreCompilerErrors: true\n\t\t\t}\n\t\t});\n\n\t\tconst { src, dest, format } = options;\n\n\t\tif (isRemoteOptions(options)) {\n\t\t\tconst repo = getGitHub(options.repo);\n\t\t\tconst cloneDirectory = options.cloneDirectory ? options.cloneDirectory : createTempDirectory(repo.name);\n\t\t\tconst missing = await getMissing(repo, options);\n\t\t\tconst pathTemplate = format === 'json' ? getJsonApiPath : getHtmlApiPath;\n\n\t\t\tif (missing.length === 0) {\n\t\t\t\tif (options.filter) {\n\t\t\t\t\tlogger.info(`No APIs match the filter: \"${ options.filter }`);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tlogger.info(`all APIs are up-to-date.`);\n\t\t\t\t}\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tfor (const release of missing) {\n\t\t\t\tconst target = pathTemplate(dest, repo.name, release.name);\n\n\t\t\t\tawait sync({\n\t\t\t\t\tbranch: release.name,\n\t\t\t\t\tcloneDirectory,\n\t\t\t\t\turl: repo.url\n\t\t\t\t});\n\n\t\t\t\tif (options.skipInstall !== true) {\n\t\t\t\t\tawait installDependencies(cloneDirectory);\n\t\t\t\t}\n\t\t\t\tawait typedoc(cloneDirectory, target, options.typedoc);\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tif (options.skipInstall === false) {\n\t\t\t\tawait installDependencies(src);\n\t\t\t}\n\t\t\tawait typedoc(resolve(src), dest, options.typedoc);\n\t\t}\n\t}\n\n\tgrunt.registerMultiTask('api', wrapAsyncTask(typedocTask));\n};\n"]}